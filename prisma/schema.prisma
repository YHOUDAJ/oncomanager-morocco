// prisma/schema.prisma
// OncoManager Morocco - Schema de base de données complet pour SQLite

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============ ENUMS (Simulés pour SQLite) ============
// Note: SQLite ne supporte pas les ENUM nativement au niveau de la DB, 
// Prisma gère cela au niveau applicatif.

// ============ MODELS ============

model Cabinet {
  id          String   @id @default(cuid())
  nom         String
  adresse     String?
  ville       String?
  telephone   String?
  email       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users       User[]
  patients    Patient[]
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  nom           String
  prenom        String
  role          String   @default("MEDECIN") // MEDECIN, SECRETAIRE, INFIRMIER, ADMIN
  passwordHash  String
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  cabinetId     String
  cabinet       Cabinet  @relation(fields: [cabinetId], references: [id])
  
  patientsCreated    Patient[]      @relation("PatientCreatedBy")
  consultations      Consultation[]
  curesCreated       Cure[]
}

model Patient {
  id                    String    @id @default(cuid())
  
  // Identité
  nom                   String
  prenom                String
  dateNaissance         DateTime
  sexe                  String    // HOMME, FEMME
  cin                   String?   @unique
  
  // Contact
  telephone             String
  telephoneSecondaire   String?
  email                 String?
  adresse               String?
  ville                 String?
  
  // Couverture médicale
  numeroCNSS            String?
  mutuelle              String?
  numeroMutuelle        String?
  
  // Informations médicales générales
  groupeSanguin         String?   // A_POSITIF, A_NEGATIF, etc.
  allergies             String?
  antecedentsMedicaux   String?
  antecedentsFamiliaux  String?
  medecinTraitant       String?
  
  // Informations oncologiques
  diagnosticPrincipal   String?
  dateDecouverteCancer  DateTime?
  stade                 String?   // TNM staging (ex: T2N1M0)
  typeHistologique      String?
  localisationPrimaire  String?
  
  // Métadonnées
  isArchived            Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  createdById           String
  createdBy             User      @relation("PatientCreatedBy", fields: [createdById], references: [id])
  cabinetId             String
  cabinet               Cabinet   @relation(fields: [cabinetId], references: [id])
  
  consultations         Consultation[]
  rendezvous            RendezVous[]
  cures                 Cure[]
  documents             Document[]
  factures              Facture[]
}

model Consultation {
  id                String   @id @default(cuid())
  date              DateTime @default(now())
  
  // Contenu
  motif             String?
  examenClinique    String?
  conclusion        String?
  prescriptions     String?
  
  // Mesures vitales
  poids             Float?   // kg
  taille            Float?   // cm
  tensionSystolique Int?     // mmHg
  tensionDiastolique Int?    // mmHg
  temperature       Float?   // °C
  frequenceCardiaque Int?    // bpm
  
  // Évaluation oncologique
  ecogStatus        Int?     // 0-5
  evaluationReponse String?  // RECIST: CR, PR, SD, PD
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  patientId         String
  patient           Patient  @relation(fields: [patientId], references: [id])
  medecinId         String
  medecin           User     @relation(fields: [medecinId], references: [id])
}

model RendezVous {
  id          String    @id @default(cuid())
  
  dateHeure   DateTime
  dureeMinutes Int      @default(30)
  type        String    @default("CONSULTATION_SUIVI") // CONSULTATION_INITIALE, CHIMIO, RADIOTHERAPIE, etc.
  statut      String    @default("PLANIFIE") // PLANIFIE, CONFIRME, EN_COURS, TERMINE, ANNULE, ABSENT
  
  motif       String?
  notes       String?
  
  // Rappels
  rappelEnvoye    Boolean   @default(false)
  dateRappel      DateTime?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  patientId   String
  patient     Patient   @relation(fields: [patientId], references: [id])
}

model Protocole {
  id              String   @id @default(cuid())
  
  nom             String   // ex: FOLFOX, AC-T, FOLFIRI
  description     String?
  nombreCycles    Int      @default(6)
  intervalleJours Int      @default(21) // jours entre chaque cure
  
  // Médicaments (JSON pour flexibilité)
  medicaments     String?  // Stocké sous forme de JSON String pour SQLite
  
  actif           Boolean  @default(true)
  createdAt       DateTime @now()
  updatedAt       DateTime @updatedAt
  
  // Relations
  cures           Cure[]
}

model Cure {
  id              String     @id @default(cuid())
  
  numeroCycle     Int        // 1, 2, 3...
  datePrevue      DateTime
  dateReelle      DateTime?
  statut          String     @default("PLANIFIEE") // PLANIFIEE, EN_COURS, TERMINEE, REPORTEE, ANNULEE
  
  // Ajustements
  dosePourcent    Int        @default(100) // % de la dose standard
  motifAjustement String?
  
  // Toxicités observées (CTCAE)
  toxicites       String?    // Stocké sous forme de JSON String
  
  // Biologie pré-cure
  pnn             Float?     // Polynucléaires neutrophiles
  plaquettes      Float?
  hemoglobine     Float?
  creatinine      Float?
  bilirubine      Float?
  
  notes           String?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  // Relations
  patientId       String
  patient         Patient    @relation(fields: [patientId], references: [id])
  protocoleId     String
  protocole       Protocole  @relation(fields: [protocoleId], references: [id])
  createdById     String
  createdBy       User       @relation(fields: [createdById], references: [id])
}

model Document {
  id          String   @id @default(cuid())
  
  nom         String
  type        String   // analyse, imagerie, cr_consultation, ordonnance, etc.
  mimeType    String?
  taille      Int?     // bytes
  url         String   // chemin ou URL du fichier
  
  description String?
  dateDocument DateTime?
  
  createdAt   DateTime @default(now())
  
  // Relations
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id])
}

model Facture {
  id            String   @id @default(cuid())
  
  numero        String   @unique
  date          DateTime @default(now())
  
  // Montants
  montantHT     Float
  montantTVA    Float    @default(0)
  montantTTC    Float
  montantPaye   Float    @default(0)
  
  // Paiement
  modePaiement  String?  // especes, cheque, carte, virement
  datePaiement  DateTime?
  
  // Détails
  lignes        String   // Stocké sous forme de JSON String
  notes         String?
  
  // CNSS / Assurance
  numeroCNSS    String?
  mutuelle      String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  patientId     String
  patient     Patient  @relation(fields: [patientId], references: [id])
}
